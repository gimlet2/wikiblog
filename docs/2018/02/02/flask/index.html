<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prometheus, Python, Flask | RestMonkeys tech blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="alternate" type="application/rss+xml" href="https://restmonkeys.com/rss.xml" title="RestMonkeys tech blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://restmonkeys.com/feed.atom" title="RestMonkeys tech blog Atom Feed">
    <link rel="alternate" type="application/json" href="https://restmonkeys.com/feed.json" title="RestMonkeys tech blog JSON Feed">
    <meta name="description" content="Python based apps are significant part of the ecosystem in our company. In the era of microservices there is really no difference which technology is in use under the hood. But each service should ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.eb280cdd.css" as="style"><link rel="preload" href="/assets/js/app.476fdfd8.js" as="script"><link rel="preload" href="/assets/js/6.e95c38f8.js" as="script"><link rel="preload" href="/assets/js/3.fff0813a.js" as="script"><link rel="preload" href="/assets/js/22.cde2f64f.js" as="script"><link rel="prefetch" href="/assets/js/10.97c218b7.js"><link rel="prefetch" href="/assets/js/11.457c9032.js"><link rel="prefetch" href="/assets/js/12.101b0f20.js"><link rel="prefetch" href="/assets/js/13.76df7937.js"><link rel="prefetch" href="/assets/js/14.cc4c6c53.js"><link rel="prefetch" href="/assets/js/15.a46a7518.js"><link rel="prefetch" href="/assets/js/16.2a2931f8.js"><link rel="prefetch" href="/assets/js/17.9d7dc5ae.js"><link rel="prefetch" href="/assets/js/18.cf01e316.js"><link rel="prefetch" href="/assets/js/19.17629d7b.js"><link rel="prefetch" href="/assets/js/20.69b8495e.js"><link rel="prefetch" href="/assets/js/21.473e1343.js"><link rel="prefetch" href="/assets/js/23.0e4b4d2f.js"><link rel="prefetch" href="/assets/js/24.a0e78e3d.js"><link rel="prefetch" href="/assets/js/4.694138ee.js"><link rel="prefetch" href="/assets/js/5.c3b94c1f.js"><link rel="prefetch" href="/assets/js/7.f1a4d31e.js"><link rel="prefetch" href="/assets/js/8.077201e3.js"><link rel="prefetch" href="/assets/js/9.2da52cfa.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.f5a07918.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eb280cdd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">RestMonkeys tech blog </a></div> <div class="header-right-wrap"><ul class="nav"></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">RestMonkeys tech blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Prometheus, Python, Flask
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2018-02-02T00:00:00.000Z">
      Fri Feb 02 2018
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/python" data-v-42ccfcd5><span data-v-42ccfcd5>python</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/kubernetes" data-v-42ccfcd5><span data-v-42ccfcd5>kubernetes</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/gunicorn" data-v-42ccfcd5><span data-v-42ccfcd5>gunicorn</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/flask" data-v-42ccfcd5><span data-v-42ccfcd5>flask</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p><strong>Python</strong> based apps are significant part of the ecosystem in our company. In the era of microservices there is really no difference which technology is in use under the hood. But each service should provide its own API and the way to monitor its state.</p> <p>In our setup we use <a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer"><strong>Prometheus</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to aggregate metrics from all our services. And it works fine. Especially with our <strong>JVM</strong> apps. But that was not a case for all out Pythons till today.</p> <p>As a historical tradition our Pythons apps are mostly done with <a href="http://flask.pocoo.org/" target="_blank" rel="noopener noreferrer"><strong>Flask</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. And it is a nice framework. In some cases it is also wrapped with <a href="http://gunicorn.org/" target="_blank" rel="noopener noreferrer"><strong>Gunicorn</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. And here is a tutorial how to make it work with Prometheus:
</p> <ol><li>Add the dependency to your project <strong>setup.py</strong> to prometheus_client==0.1.1</li> <li>Inside your application define some metrics you want to collect, for example: FLASK_REQUEST_LATENCY = Histogram(__name__.replace(‘.’, ‘_’) + ‘_request_latency_seconds’, ‘Flask Request Latency’) .</li> <li>Annotate a method you want to measure with @FLASK_REQUEST_LATENCY.time()</li> <li>Add endpoint to expose the statistics:</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/stats'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> generate_latest<span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span> <span class="token comment">#registry is global</span>
</code></pre></div><p>And that’s it! If your app is just plain Flask without Gunicorn. To make it work in multiprocessor scenario you need to make several additional steps:</p> <ol start="5"><li>Create config for Gunicorn:</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">worker_exit</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> worker<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> multiprocess
    multiprocess<span class="token punctuation">.</span>mark_process_dead<span class="token punctuation">(</span>worker<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>
</code></pre></div><ol start="6"><li><p>This config can be provided to <strong>gunicorn</strong> cli with <strong>-c</strong>  flag.</p></li> <li><p>Add Environment variable prometheus_multiproc_dir that should point to a directory where Prometheus can temporarily store the metrics. If you use <strong>Kubernetes</strong> update the deployment descriptor to mount <strong>Volume</strong> with <strong>emptyDir</strong>  type.</p></li> <li><p>And the last thing to do — update code for your /stats endpoint like this:</p></li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/stats'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    registry <span class="token operator">=</span> CollectorRegistry<span class="token punctuation">(</span><span class="token punctuation">)</span>
    multiprocess<span class="token punctuation">.</span>MultiProcessCollector<span class="token punctuation">(</span>registry<span class="token punctuation">)</span>
    <span class="token keyword">return</span> generate_latest<span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span>
</code></pre></div><p>I hope this short guide can be useful and will help you to make your apps measurable and system more reliable.</p></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/gimlet2" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="https://twitter.com/gimlet2" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-3d9deeb8><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.476fdfd8.js" defer></script><script src="/assets/js/6.e95c38f8.js" defer></script><script src="/assets/js/3.fff0813a.js" defer></script><script src="/assets/js/22.cde2f64f.js" defer></script>
  </body>
</html>
