<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Code sharing between Kotlin and Kotlin-Native | RestMonkeys tech blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="alternate" type="application/rss+xml" href="https://restmonkeys.com/rss.xml" title="RestMonkeys tech blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://restmonkeys.com/feed.atom" title="RestMonkeys tech blog Atom Feed">
    <link rel="alternate" type="application/json" href="https://restmonkeys.com/feed.json" title="RestMonkeys tech blog JSON Feed">
    <meta name="description" content="Nowadays when popularity of Kotlin grows faster then ever JetBrains puts a lot of energy to bring us new Kotlin universe — Kotlin-Native. Kotlin-Native al ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.eb280cdd.css" as="style"><link rel="preload" href="/assets/js/app.afe70faf.js" as="script"><link rel="preload" href="/assets/js/6.e95c38f8.js" as="script"><link rel="preload" href="/assets/js/3.fff0813a.js" as="script"><link rel="preload" href="/assets/js/11.457c9032.js" as="script"><link rel="prefetch" href="/assets/js/10.97c218b7.js"><link rel="prefetch" href="/assets/js/12.101b0f20.js"><link rel="prefetch" href="/assets/js/13.76df7937.js"><link rel="prefetch" href="/assets/js/14.cc4c6c53.js"><link rel="prefetch" href="/assets/js/15.a46a7518.js"><link rel="prefetch" href="/assets/js/16.2a2931f8.js"><link rel="prefetch" href="/assets/js/17.9d7dc5ae.js"><link rel="prefetch" href="/assets/js/18.cf01e316.js"><link rel="prefetch" href="/assets/js/19.17629d7b.js"><link rel="prefetch" href="/assets/js/20.69b8495e.js"><link rel="prefetch" href="/assets/js/21.473e1343.js"><link rel="prefetch" href="/assets/js/22.cde2f64f.js"><link rel="prefetch" href="/assets/js/23.0e4b4d2f.js"><link rel="prefetch" href="/assets/js/24.a0e78e3d.js"><link rel="prefetch" href="/assets/js/4.694138ee.js"><link rel="prefetch" href="/assets/js/5.c3b94c1f.js"><link rel="prefetch" href="/assets/js/7.f1a4d31e.js"><link rel="prefetch" href="/assets/js/8.077201e3.js"><link rel="prefetch" href="/assets/js/9.2da52cfa.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.f5a07918.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eb280cdd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">RestMonkeys tech blog </a></div> <div class="header-right-wrap"><ul class="nav"></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">RestMonkeys tech blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Code sharing between Kotlin and Kotlin-Native
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2017-07-21T00:00:00.000Z">
      Fri Jul 21 2017
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/kotlin-native" data-v-42ccfcd5><span data-v-42ccfcd5>kotlin-native</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/https" data-v-42ccfcd5><span data-v-42ccfcd5>https</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/kotlin" data-v-42ccfcd5><span data-v-42ccfcd5>kotlin</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>Nowadays when popularity of Kotlin grows faster then ever JetBrains puts a lot of energy to bring us new Kotlin universe — <a href="https://github.com/JetBrains/kotlin-native" target="_blank" rel="noopener noreferrer">Kotlin-Native<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Kotlin-Native allows us to build native apps. It based on <a href="http://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> compiler and supports various of platforms. It still somewhere far from being production ready but we already have the third release — <a href="https://github.com/JetBrains/kotlin-native/releases/tag/v0.3" target="_blank" rel="noopener noreferrer">version 0.3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>I have one let’s say pet-project I’ve already <a href="/2016/11/16/kottpd/">wrote</a> about — <a href="https://github.com/gimlet2/kottpd" target="_blank" rel="noopener noreferrer">kottpd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It is simple HTTP-server written entirely in Kotlin. From this two facts I’ve made obvious decision — I need to try to port my library to Kotlin-Native! But that is not only for fun. There is one dream behind it — to make it possible to build web apps in Kotlin but with possibility to run them with native performance.
 <img src="/assets/img/2017-07-21-1.5f35350b.jpeg" alt="">
Well, to be honest, it is only an experiment for now. But let’s see where this experiment will lead later.</p> <p>As a first step I’ve cut all unimportant parts out — SSL support, files serving, exception handling and even multi-thread support. And it still was able to serve HTTP requests. Great! Let’s move on.</p> <p>The second step was a little bit harder. I had to go through all codebase and remove all direct references to JVM classes. In my case it was java.net. <strong>ServerSocket</strong> , java.net. <strong>Socket</strong> , java.io. <strong>OutputStream</strong> , java.io. <strong>OutputStreamWriter</strong> , java.io. <strong>PrintWriter</strong> , java.io. <strong>BufferedReader</strong> , java.io. <strong>InputStream</strong> , java.io. <strong>InputStreamReader</strong> , java.io. <strong>IOException</strong> , java.lang. <strong>System</strong>. Not that big list.</p> <p>Instead of all those classes I’ve introduced corresponding interfaces and exceptions. And that help me to isolate all platform dependent logic from, let’s say, business logic of the library. On that moment I did check how it works once again. And it was fine. Time to move to Kotlin-Native!</p> <p>The code was copied to separate folder. And I had no idea what to do next. But, thanks to JetBrains team, we have some examples that come along with Kotlin-Native. For inspiration I choose <a href="https://github.com/JetBrains/kotlin-native/tree/master/samples/socket" target="_blank" rel="noopener noreferrer"><strong>socket</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sample. There I took <strong>build.gradle</strong> file and <strong>sockets.def</strong> for configuring C interop. On that moment I realized how far Kotlin-Native is from production use right now — there is no IDE support. That remind me old good times at school with Pascal — change code, compile, read error messages, fix code =)! And that what we have now with Kotlin-Native. Most of the time error messages give you enough information to actually get what is wrong.</p> <p>Beside pure tooling I’ve faced not so many issues — <strong>fun main(args: Array&lt;String&gt;)</strong>— must be in a file without package, type conversions from native world and back are two biggest of them.</p> <p>But anyway I made it work! In one thread, crashing time to time with segmentation fault but still serving HTTP requests!</p> <p>There is more thoughts to improve it — bring all pieces removed due to simplification back, introduce multi-threading and improve build process to make it actually one application with common code base!</p> <p>If you interested in this experiment please follow on <a href="https://github.com/gimlet2/kottpd/tree/nativizy" target="_blank" rel="noopener noreferrer">github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/gimlet2" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="https://twitter.com/gimlet2" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-3d9deeb8><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.afe70faf.js" defer></script><script src="/assets/js/6.e95c38f8.js" defer></script><script src="/assets/js/3.fff0813a.js" defer></script><script src="/assets/js/11.457c9032.js" defer></script>
  </body>
</html>
